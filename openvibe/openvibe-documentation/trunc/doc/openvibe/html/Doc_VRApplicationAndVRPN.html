<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>OpenViBE documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<!-- <link href="tabs.css" rel="stylesheet" type="text/css"> -->
</head>
<body>
<div id="main">
	<div id="title">
		<center>
		<a name="page-top"></a>
		<table width=95%>
			<tr>
				<td><a href="http://openvibe.inria.fr" class="leaving-link" onclick="window.open(this.href,'openvibe-software'); return false;"><img src="logo.png" /></a></td>
				<td width=100%>OpenViBE Documentation</td>
			</tr>
		</table>
		</center>
	</div>
	<div id="menu">
		<div id="menu-content">
			<ul>
				<li><a href="index.html">OpenViBE Documentation</a></li>
			</ul>
			<div class="menu-title">Doxygen</div>
			<ul>
				<!-- <li><a href="pages.html">Related</a></li> -->
				<li><a href="modules.html">Modules</a></li>
				<li><a href="namespaces.html">Namespaces</a></li>
				<li><a href="annotated.html">Class List</a>
				<li><a href="classes.html">Class Index</a>
				<li><a href="hierarchy.html">Class Hierarchy</a>
				<!-- <li><a href="files.html">Files (buggy)</a></li> -->
			</ul>
			<div class="menu-title">Quick Access</div>
			<ul>
				<li><a href="http://openvibe.inria.fr/start" class="leaving-link">Video Tutorials</a></li>
				<li><a href="http://openvibe.inria.fr/faq">FAQ</a></li>
				<li><a href="http://openvibe.inria.fr/license">Licence</a></li>
				<li><a href="http://openvibe.inria.fr/build-instructions/">Build Instructions</a></li>
				<li><a href="http://openvibe.inria.fr/documentation-index/#User+Documentation">User Doc</a></li>
				<li><a href="http://openvibe.inria.fr/documentation-index/#Developer+Documentation">Developer Doc</a></li>
				<li><a href="Doc_BoxAlgorithms.html">Exisiting Boxes</a></li>
			</ul>
			<div class="menu-title">Contact</div>
			<ul>
				<li><a href="http://openvibe.inria.fr" class="leaving-link" onclick="window.open(this.href,'openvibe-software'); return false;">Software Home</a></li>
				<li><a href="http://openvibe.inria.fr/forum" class="leaving-link" onclick="window.open(this.href,'openvibe-forum'); return false;">Forum</a></li>
				<li><a href="https://gforge.inria.fr/projects/openvibe" class="leaving-link" onclick="window.open(this.href,'openvibe-forge'); return false;">INRIA gForge</a></li>
				<li><a href="https://gforge.inria.fr/mail/?group_id=276" class="leaving-link" onclick="window.open(this.href,'openvibe-forge'); return false;">Mailing Lists</a></li>
				<li><a href="http://openvibe.inria.fr/tracker" class="leaving-link" onclick="window.open(this.href,'openvibe-tracker'); return false;">Bug Tracker</a></li>
				<li><a href="http://www.irisa.fr/bunraku/OpenViBE/wiki/index.php?title=Main_Page" class="leaving-link" onclick="window.open(this.href,'openvibe-wiki'); return false;">Research Project</a></li>
				<li><b>IRC</b> : <span style="font-size: x-small; font-style: italic;">#openvibe</span> on <span style="font-size: x-small; font-style: italic;">irc.freenode.net</span></li>
				<li><b>Project Leader</b> : Anatole L&eacute;cuyer, Inria <span style="font-size: x-small; font-style: italic;">(anatole dot lecuyer at inria dot fr)</span></li>
				<li><b>Lead Software Engineer</b> : Laurent Bonnet, Inria <span style="font-size: x-small; font-style: italic;">(laurent dot bonnet at inria dot fr)</span></li>
			</ul>
			<div class="menu-title">Share this</div>
			<ul><li><span style="font-size: x-small; font-style: italic;">This documentation is licenced under <b>CC-BY-SA</b></span></li></ul>
			<td><a href="http://creativecommons.org/licenses/by-sa/3.0/legalcode" class="leaving-link" onclick="window.open(this.href,'cc-by-sa'); return false;"><img src="cc-by-sa.png" /></a></td>
			<br>
			<div class="menu-title">Search</div>
			<form action="search.php" method="get" id="search">
				<fieldset>
					<input class="search" type="text" name="q" value="Quick Search..." onfocus="this.value='';" />
				</fieldset>
			</form>
		</div>
	</div>
	<div class="content-container">
<!-- Generated by Doxygen 1.8.1.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="Doc_DeveloperDocumentation.html">Developer Documentation</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Creating a Virtual Reality application with Ogre3D and connecting it to <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> with VRPN </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="important"> This documentation page is deprecated since <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> 0.12.0 (oct 2011), and won't be maintained.  The new page can be found  <a href="http://openvibe.inria.fr/tutorial-vr-application-ogre-vrpn/"> here </a> .</div><ul>
<li><b>NB:</b> Document based on <b> <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> 0.5.0 </b> (18-feb-2010).</li>
</ul>
<h1><a class="anchor" id="Doc_VRApplicationAndVRPN_Intro"></a>
Introduction</h1>
<p><a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> can be used to its full potency by designing and creating a complete BCI application. The previous turorials covered the acquisition process and the signal processing boxes. We will see in this tutorial how to create the last link of the chain: an elaborated feedback. <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> provides everything to set up your first Virtual Reality (VR) application using the rendering engine Ogre3D, free and open-source. The tutorial will also cover how the VRPN protocol can be used in <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> to interact with the third-party application. We strongly recommend to look at the VR application given with the software: "Use-The-Force" (a.k.a. the tie-fighter demonstrator), where the participant has to lift a spaceship by using motor imagery of the feet.</p>
<p>Nota Bene:</p>
<ul>
<li>Source code of the tie-fighter demonstrator is under <em>/openvibe-applications/vr-demo</em>.</li>
<li>For any further information on Ogre3D, please look at the official manual and wiki (<a href="http://www.ogre3d.org/">http://www.ogre3d.org/</a>).</li>
<li>Regarding VRPN, more information can be found at <a href="http://www.cs.unc.edu/Research/vrpn/">http://www.cs.unc.edu/Research/vrpn/</a>.</li>
</ul>
<h1><a class="anchor" id="Doc_VRApplicationAndVRPN_Loop"></a>
The interaction loop</h1>
<p>This first part describes the BCI interaction loop, and how it works in <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a>. We are working with a complete BCI, where several entities are brought into play:</p>
<ul>
<li>Participant.</li>
<li>EEG recording device (electrodes and amplifier).</li>
<li>Real-time analysis program, <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> for example.</li>
<li>Feedback, a VR application for example.</li>
</ul>
<p>As described in the figure below each entity is linked to the others: an interaction loop is created for the participant. By changing his mental behaviour, he can modify the sensorial feedback the application gives him.</p>
<div class="image">
<img src="loop.png" alt="loop.png"/>
<div class="caption">
The interaction loop</div></div>
<p> The connection between <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> and the VR application is made through the Virtual Reality Peripheral Network (VRPN) (<a href="http://www.cs.unc.edu/Research/vrpn/">http://www.cs.unc.edu/Research/vrpn/</a>), which relies on a client-server architecture. We provide with <a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> an implementation of both part.</p>
<h1><a class="anchor" id="Doc_VRApplicationAndVRPN_VRPN"></a>
VRPN</h1>
<h2><a class="anchor" id="Doc_VRApplicationAndVRPN_VRPN_Server"></a>
The server side</h2>
<p>The Designer is in charge of the VRPN server(s):</p>
<ul>
<li>Doc_BoxAlgorithm_AnalogVRPNServer for floating point values, one server can handle any number of variables.</li>
<li>Doc_BoxAlgorithm_ButtonVRPNServer for two-states buttons, one server can handle any number of buttons.</li>
</ul>
<p>One Analog Server and one Button Server constitute one VRPN Peripheral or device, with a given name ("openvibe-vrpn" for example). Thus, if you need more than one of each type of server, you have to create another peripheral by giving the additional servers another name.</p>
<h2><a class="anchor" id="Doc_VRApplicationAndVRPN_VRPN_Client"></a>
The client side</h2>
<p>The VR application must now implement VRPN client(s). You can design your application the way you want, with any tool you may need. For example, the Blender Game Engine can be customize to include a VRPN client, implemented with python.</p>
<p><a class="el" href="namespaceOpenViBE.html" title="Main OpenViBE namespace.">OpenViBE</a> includes a basic framework that can be used to create VR application. The VRPN client side is given in the class <a class="el" href="classOpenViBEVRDemos_1_1CAbstractVrpnPeripheral.html" title="A VRPN peripheral abstraction, client side.">OpenViBEVRDemos::CAbstractVrpnPeripheral</a>. This object gives an abstraction of a VRPN peripheral. A CAbstractVrpnPeripheral object contains a CDeviceInfo, that can handle at most one Analog Remote object and one Button Remote object. </p>
<div class="fragment"><div class="line"><span class="keyword">class </span>CDeviceInfo</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">        std::string m_sAddress;        <span class="comment">// Device address</span></div>
<div class="line">        vrpn_Button_Remote* m_pButton; <span class="comment">// Pointer to a Button Remote</span></div>
<div class="line">        vrpn_Analog_Remote* m_pAnalog; <span class="comment">// Pointer to an Analog Remote</span></div>
<div class="line">};</div>
</div><!-- fragment --><p>The VRPN protocol relies on handler mechanism. Each VRPN Remote object has a registered handler, which will be called automatically when a change is detected on the server side (button switched or analog value modified). Our implementation of these handlers stores all the new values in standard containers, for further use by the application. </p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> VRPN_CALLBACK handle_button(<span class="keywordtype">void</span>* pUserData, <span class="keyword">const</span> vrpn_BUTTONCB b)</div>
<div class="line">{</div>
<div class="line">        CAbstractVrpnPeripheral* l_pAbstractVrpnPeripheral=(CAbstractVrpnPeripheral *)pUserData;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// we save the new button state, in a pair (button_id,button_state)</span></div>
<div class="line">        std::pair &lt; int, int &gt; l_oVrpnButtonState;</div>
<div class="line">        l_oVrpnButtonState.first=b.button;</div>
<div class="line">        l_oVrpnButtonState.second=b.state;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// we store it in a list</span></div>
<div class="line">        l_pAbstractVrpnPeripheral-&gt;m_vButton.push_back(l_oVrpnButtonState);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> VRPN_CALLBACK handle_analog(<span class="keywordtype">void</span>* pUserData, <span class="keyword">const</span> vrpn_ANALOGCB a)</div>
<div class="line">{</div>
<div class="line">        CAbstractVrpnPeripheral* l_pAbstractVrpnPeripheral=(CAbstractVrpnPeripheral *)pUserData;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// we save the new values in a list (one value for each channel in the Analog Server)</span></div>
<div class="line">        std::list &lt; double &gt;  l_oVrpnAnalogState;</div>
<div class="line">        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;a.num_channel; i++)</div>
<div class="line">        {</div>
<div class="line">                <span class="comment">// User-defined scale &amp; offset (1 &amp; 0 by default)</span></div>
<div class="line">                l_oVrpnAnalogState.push_back(a.channel[i]*l_pAbstractVrpnPeripheral-&gt;m_dAnalogScale</div>
<div class="line">                                             +l_pAbstractVrpnPeripheral-&gt;m_dAnalogOffset);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//we store it in a list</span></div>
<div class="line">        l_pAbstractVrpnPeripheral-&gt;m_vAnalog.push_back(l_oVrpnAnalogState);</div>
<div class="line">}</div>
</div><!-- fragment --><p>When you create the peripheral, you must specify the address of the VRPN server you want to connect to. This address is basically [peripheral-name]@[hostname] ("openvibe-vrpn@localhost" for example. </p>
<div class="fragment"><div class="line">CAbstractVrpnPeripheral(<span class="keyword">const</span> std::string deviceAddress);</div>
</div><!-- fragment --><p>Then, the initialisation process will set up the CDeviceInfo and create the remote connection with the servers. VRPN provides dynamic and robust connection mechanism, thus you can start and stop servers or clients at will, without problem. Finally, the handlers are registered for each VRPN Remote. </p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> CAbstractVrpnPeripheral::init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">        m_pDevice=<span class="keyword">new</span> CDeviceInfo;</div>
<div class="line">        m_pDevice-&gt;m_sAddress=m_sDeviceAddress;</div>
<div class="line">        m_pDevice-&gt;m_pAnalog=<span class="keyword">new</span> vrpn_Analog_Remote(m_sDeviceAddress.c_str());</div>
<div class="line">        m_pDevice-&gt;m_pButton=<span class="keyword">new</span> vrpn_Button_Remote(m_sDeviceAddress.c_str());</div>
<div class="line"></div>
<div class="line">        m_pDevice-&gt;m_pButton-&gt;register_change_handler(<span class="keyword">this</span>, &amp;handle_button);</div>
<div class="line">        m_pDevice-&gt;m_pAnalog-&gt;register_change_handler(<span class="keyword">this</span>, &amp;handle_analog);</div>
<div class="line">}</div>
<div class="line">  \encode</div>
<div class="line"> </div>
<div class="line">  The last step is the loop <span class="keyword">function</span>, that has to be called regularly. </div>
<div class="line">  It simply calls the main loop of the VRPN Remote <span class="keywordtype">object</span>.</div>
<div class="line">  \code</div>
<div class="line"><span class="keywordtype">void</span> CAbstractVrpnPeripheral::loop(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">        m_pDevice-&gt;m_pButton-&gt;mainloop();</div>
<div class="line">        m_pDevice-&gt;m_pAnalog-&gt;mainloop();</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="Doc_VRApplicationAndVRPN_Ogre"></a>
Ogre3D VR application</h1>
<p>The framework is based on Ogre3D. To design your own VR application, you have to inherit the given basic class: <a class="el" href="classOpenViBEVRDemos_1_1COgreVRApplication.html" title="Basic framework to design VR applications.">OpenViBEVRDemos::COgreVRApplication</a>. This class handles for you pretty much everything related to Ogre and VRPN startup sequence, and their main loop calls. You must only implement 2 specialized functions:</p>
<ul>
<li>COgreVRApplication::initialise(void), where you load your 3D scene. <div class="fragment"><div class="line"><span class="keywordtype">bool</span> CMyRVApplication::initialise()</div>
<div class="line">{</div>
<div class="line">        <span class="comment">//----------- LIGHTS -------------//</span></div>
<div class="line">        m_poSceneManager-&gt;setAmbientLight(Ogre::ColourValue(0.4, 0.4, 0.4));</div>
<div class="line">        m_poSceneManager-&gt;setShadowTechnique(SHADOWTYPE_TEXTURE_MODULATIVE);</div>
<div class="line"></div>
<div class="line">        Ogre::Light* l_poLight1 = m_poSceneManager-&gt;createLight(<span class="stringliteral">&quot;Light1&quot;</span>);</div>
<div class="line">        l_poLight1-&gt;setPosition(-2,6,2);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">//...</span></div>
<div class="line">        <span class="comment">// Load meshes, modify the camera, set the GUI, etc. </span></div>
<div class="line">        <span class="comment">//...</span></div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>COgreVRApplication::process(void), where you use the newly received VRPN values (button state or analog values) and give the feedback to the participant. <div class="fragment"><div class="line"><span class="keywordtype">bool</span> CMyRVApplication::process()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// we iterate over the Button states received</span></div>
<div class="line">    <span class="keywordflow">while</span>(!m_poVrpnPeripheral-&gt;m_vButton.empty())</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// we take the last pair (button_id, button_state)</span></div>
<div class="line">        std::pair &lt; int, int &gt;&amp; l_rVrpnButtonState=m_poVrpnPeripheral-&gt;m_vButton.front();</div>
<div class="line">        <span class="comment">//...</span></div>
<div class="line">        <span class="comment">// Insert your specific behaviour here: </span></div>
<div class="line">        <span class="comment">// update local variables, change phases according to the button switched, etc. </span></div>
<div class="line">        <span class="comment">//...</span></div>
<div class="line">        <span class="comment">// we discard the pair</span></div>
<div class="line">        m_poVrpnPeripheral-&gt;m_vButton.pop_front();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If we received new values</span></div>
<div class="line">    <span class="keywordflow">if</span>(!m_poVrpnPeripheral-&gt;m_vAnalog.empty())</div>
<div class="line">    {</div>
<div class="line">            <span class="comment">// we take the list of values, one for each channel in the Analog Server.</span></div>
<div class="line">            std::list &lt; double &gt;&amp; l_rVrpnAnalogState=m_poVrpnPeripheral-&gt;m_vAnalog.front();</div>
<div class="line">            <span class="comment">//...</span></div>
<div class="line">        <span class="comment">// Insert your specific behaviour here. </span></div>
<div class="line">        <span class="comment">//...</span></div>
<div class="line">            m_poVrpnPeripheral-&gt;m_vAnalog.pop_front();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//...</span></div>
<div class="line">    <span class="comment">// Use your updated information to give feedback to the participant.</span></div>
<div class="line">    <span class="comment">//...</span></div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ul>
<p>You will find in the function COgreVRApplication::setup(void) the startup sequence:</p>
<ul>
<li>OgreRoot creation.</li>
<li>Resource setup &amp; loading.</li>
<li>Graphic driver and window configuration loading.</li>
<li>OIS initialization (to read inputs from keyboard/mouse).</li>
<li>CEGUI initialization (to display 2D widgets).</li>
<li>Listener registration.</li>
<li>VRPN peripheral creation.</li>
<li>Default Camera creation.</li>
</ul>
<p>The COgreVRApplication::go(void) function calls this setup sequence, and your specific function CMyRVApplication::initialise(void) next. The Ogre rendering engine can then be started.</p>
<p>The callback COgreVRApplication::frameStarted(const FrameEvent&amp; evt), called each time a frame is rendered (limited to a defined frequency), handles OIS and VRPN main loops. It also calls your specific implementation CMyRVApplication::process(void).</p>
<p>Bye default, the callback COgreVRApplication::keyPressed(const OIS::KeyEvent&amp; evt) will stop the rendering process and exit the application when the ESCAPE key is pressed. All other callbacks (mouse and keyboard related events) are simply returning successfully without any action. Of course, you can overload these callbacks to match your particular needs.</p>
<p>To use your new application, you just need to create it and launch the COgreVRApplication::go(void) function. </p>
<div class="fragment"><div class="line"><a class="code" href="classOpenViBEVRDemos_1_1COgreVRApplication.html" title="Basic framework to design VR applications.">OpenViBEVRDemos::COgreVRApplication</a> * app;</div>
<div class="line">app = <span class="keyword">new</span> OpenViBEVRDemos::CMyRVApplication();</div>
<div class="line">app-&gt;<a class="code" href="classOpenViBEVRDemos_1_1COgreVRApplication.html#a85c73ce4a95d5cac3e61240e58991a86" title="Launches the application (engine setup, initialization, rendering start).">go</a>();</div>
<div class="line"><span class="keyword">delete</span> app;</div>
</div><!-- fragment --><p>The main program in the file <em>ovavrd_main.cpp</em> is used to generate the <em>vr-demo</em> application. The argument of the program is the name of the application. Currently, only the "tie-fighter" and the "handball" applications are available, but you can easily add your own application. Be sure that the name you give to your VR application is the same as the root directory of its shared files (example: <em>share/openvibe-applications/vr-demo/tie-fighter</em> for the application named "tie-fighter"). The auto-generated script <em>test-vr-demo.cmd</em> (or <em>test-vr-demo</em> on Linux) will need this coherence. </p>
</div></div><!-- contents -->
	</div>
	<div class='clear-both'></div>
	<div id="footer">
		<center>
		<table width=95%>
			<tr>
				<td style="text-align:left;"><a href="#page-top">Back to top</a></td>
				<td style="text-align:right;">Generated on Fri Sep 26 2014 00:47:34 for Documentation by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.8.1.2</td>
			</tr>
		</table>
		</center>
	</div>
</div>
</body>
</html>
